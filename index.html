<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>びわ湖3cm電池シミュレータ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; width: 100%; margin-bottom: 10px; }
    body { font-family: sans-serif; line-height: 1.6; padding: 20px; }
    .info { margin-top: 10px; font-weight: bold; }
    .bar-container {
      position: relative; width: 80px; height: 100px; border: 1px solid #444;
      background-color: #f0f0f0; margin: 10px 10px 30px 0;
    }
    .bar { position: absolute; bottom: 0; width: 100%; transition: height 0.5s; }
    #lakeLevelBar { background-color: #0277bd; }
    #energyLevelBar { background-color: #e53935; }
    .bar-value-label {
      position: absolute; width: 100%; text-align: center; font-size: 0.8em;
      font-weight: bold; color: #000; top: 0; pointer-events: none;
    }
    .bar-label { text-align: center; font-size: 0.9em; }
    .bar-area { display: flex; gap: 40px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>びわ湖3cm電池シミュレータ</h2>
  <p>地図をクリックすると、標高差と発電量、琵琶湖水位差、最短水際までの距離が表示されます。</p>
  <div id="map"></div>
  <div class="info" id="coords">緯度・経度：--</div>
  <div class="info" id="elevation">上池標高：-- m</div>
  <div class="info" id="drop">有効落差：-- m</div>
  <div class="info" id="energy">位置エネルギー：-- GWh</div>
  <div class="info" id="suii">琵琶湖水位差：-- mm</div>
  <div class="info" id="distance">最短距離：-- km</div>

  <div class="bar-area">
    <div>
      <div class="bar-container">
        <div id="lakeLevelBar" class="bar"></div>
        <div id="lakeValueLabel" class="bar-value-label"></div>
      </div>
      <div class="bar-label">水位変動（mm）</div>
    </div>
    <div>
      <div class="bar-container">
        <div id="energyLevelBar" class="bar"></div>
        <div id="energyValueLabel" class="bar-value-label"></div>
      </div>
      <div class="bar-label">エネルギー（GWh）</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const lakeEdgePoints = [
      { lat: 35.334898, lng: 136.000000 },
      { lat: 35.334632, lng: 136.010366 },
      { lat: 35.333835, lng: 136.020691 },
      { lat: 35.332509, lng: 136.030934 },
      { lat: 35.330660, lng: 136.041055 },
      { lat: 35.320000, lng: 136.050000 },
      { lat: 35.300000, lng: 136.060000 },
      { lat: 35.280000, lng: 136.040000 },
      { lat: 35.260000, lng: 136.020000 },
      { lat: 35.240000, lng: 136.000000 },
      { lat: 35.220000, lng: 135.980000 },
      { lat: 35.200000, lng: 135.960000 },
      { lat: 35.180000, lng: 135.940000 },
      { lat: 35.160000, lng: 135.950000 },
      { lat: 35.150000, lng: 135.970000 },
      { lat: 35.160000, lng: 135.990000 },
      { lat: 35.180000, lng: 136.010000 },
      { lat: 35.200000, lng: 136.030000 },
      { lat: 35.220000, lng: 136.050000 },
      { lat: 35.240000, lng: 136.060000 }
    ];

    const biwakoElevation = 85.0;
    const lakeArea = 670000000;
    const volume = 20100000;
    const massTons = volume;
    let lineLayer;

    const map = L.map('map').setView([35.2, 136.0], 9);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '© OpenTopoMap (CC-BY-SA)'
    }).addTo(map);

    function toRad(deg) {
      return deg * Math.PI / 180;
    }

    function calcDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    map.on('click', function (e) {
      const lat = e.latlng.lat;
      const lon = e.latlng.lng;
      document.getElementById('coords').textContent = `緯度・経度：${lat.toFixed(6)}, ${lon.toFixed(6)}`;

      fetch(`https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?lon=${lon}&lat=${lat}&outtype=JSON`)
        .then(res => res.json())
        .then(data => {
          const elev = parseFloat(data.elevation);
          document.getElementById('elevation').textContent = `上池標高：${elev.toFixed(1)} m`;
          const drop = elev - biwakoElevation;
          document.getElementById('drop').textContent = `有効落差：${drop.toFixed(1)} m`;
          const energyJoules = massTons * 1000 * 9.8 * drop;
          const energyGWh = energyJoules / 3.6e12;
          document.getElementById('energy').textContent = `位置エネルギー：${energyGWh.toFixed(3)} GWh`;
          const suiisa = (volume * 1000) / lakeArea;
          document.getElementById('suii').textContent = `琵琶湖水位差：${suiisa.toFixed(3)} mm`;

          let minDist = Infinity;
          let nearestPoint = null;
          lakeEdgePoints.forEach(pt => {
            const d = calcDistance(lat, lon, pt.lat, pt.lng);
            if (d < minDist) {
              minDist = d;
              nearestPoint = pt;
            }
          });

          document.getElementById('distance').textContent = `最短距離：${minDist.toFixed(2)} km`;

          if (lineLayer) map.removeLayer(lineLayer);
          const nearestLatLng = L.latLng(nearestPoint.lat, nearestPoint.lng);
          lineLayer = L.polyline([e.latlng, nearestLatLng], { color: 'blue' }).addTo(map);

          document.getElementById('lakeLevelBar').style.height = Math.min(100, suiisa) + '%';
          document.getElementById('lakeValueLabel').textContent = suiisa.toFixed(1) + ' mm';

          const energyBar = Math.min(100, (energyGWh / 100) * 100);
          document.getElementById('energyLevelBar').style.height = energyBar + '%';
          document.getElementById('energyValueLabel').textContent = energyGWh.toFixed(2) + ' GWh';
        })
        .catch(() => {
          document.getElementById('elevation').textContent = `標高取得失敗`;
        });
    });
  </script>
</body>
</html>
